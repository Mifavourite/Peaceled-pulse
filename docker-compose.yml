version: '3.8'

services:
  # HashiCorp Vault for secrets management
  vault:
    image: hashicorp/vault:latest
    container_name: secure_vault
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "dev-root-token"
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
      VAULT_ADDR: "http://0.0.0.0:8200"
    volumes:
      - vault-data:/vault/data
      - ./vault/config:/vault/config
    cap_add:
      - IPC_LOCK
    networks:
      - secure_network

  # WireGuard VPN for network isolation
  wireguard:
    image: linuxserver/wireguard:latest
    container_name: secure_wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      - SERVERURL=wireguard.example.com
      - SERVERPORT=51820
      - PEERS=1
      - PEERDNS=auto
      - INTERNAL_SUBNET=10.13.13.0
    volumes:
      - ./wireguard/config:/config
      - /lib/modules:/lib/modules:ro
    ports:
      - "51820:51820/udp"
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    networks:
      - secure_network
    restart: unless-stopped

  # Trivy for security scanning
  trivy:
    image: aquasec/trivy:latest
    container_name: secure_trivy
    volumes:
      - ./scan-results:/results
      - ./:/workspace
    networks:
      - secure_network
    command: >
      sh -c "trivy fs --format json --output /results/trivy-report.json /workspace &&
             trivy fs --format table --output /results/trivy-report.txt /workspace"

  # Clair for container vulnerability scanning
  clair:
    image: quay.io/coreos/clair:latest
    container_name: secure_clair
    ports:
      - "6060:6060"
      - "6061:6061"
    volumes:
      - ./clair/config:/config
    networks:
      - secure_network
    restart: unless-stopped

  # PostgreSQL for Clair database
  postgres:
    image: postgres:15-alpine
    container_name: secure_postgres
    environment:
      POSTGRES_PASSWORD: "secure_password_change_me"
      POSTGRES_DB: clair
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - secure_network
    restart: unless-stopped

volumes:
  vault-data:
  postgres-data:

networks:
  secure_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
